name: Archive Stats

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©åŒ—äº¬æ—¶é—´ 10:00 è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch: # éšæ—¶å¯ä»¥æ‰‹åŠ¨ç‚¹è¿è¡Œ

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch and Process Data
        env:
          WORKER_URL: "https://lol-stats.closur3.workers.dev/backup"
        run: |
          import requests
          import os
          import re
          from datetime import datetime, timedelta, timezone

          # 1. è®¾å®šåŒ—äº¬æ—¶é—´ (CST)
          cst_tz = timezone(timedelta(hours=8))
          now_cst = datetime.now(cst_tz).strftime("%Y-%m-%d %H:%M:%S")

          url = os.environ["WORKER_URL"]
          print(f"æ­£åœ¨æŠ“å–: {url}")
          
          try:
              resp = requests.get(url, timeout=30)
              resp.raise_for_status()
              data = resp.json()
              
              for file_path, content in data.items():
                  # æ³¨å…¥æœ¬æ¬¡ Action è¿è¡Œçš„çœŸå®æ—¶é—´
                  new_full_content = content.replace("{{UPDATED_TIME}}", now_cst)
                  os.makedirs(os.path.dirname(file_path), exist_ok=True)
                  
                  # 2. æ ¸å¿ƒæ¯”å¯¹é€»è¾‘ï¼šå¿½ç•¥æ—¶é—´æˆ³è¡Œï¼Œå¯¹æ¯”æ•°æ®
                  should_write = True
                  if os.path.exists(file_path):
                      with open(file_path, "r", encoding="utf-8") as f:
                          old_content = f.read()
                      
                      # æŠ¹é™¤æ—§æ–‡ä»¶å’Œæ–°å†…å®¹é‡Œçš„ Updated è¡Œå†æ¯”å¯¹
                      clean_old = re.sub(r"\*\*Updated:\*\*.*\(CST\)", "", old_content).strip()
                      clean_new = re.sub(r"\*\*Updated:\*\*.*\(CST\)", "", new_full_content).strip()
                      
                      if clean_old == clean_new:
                          print(f"è·³è¿‡ {file_path}: æ¯”èµ›æ•°æ®æ— å˜åŒ–")
                          should_write = False
                  
                  # 3. åªæœ‰æ•°æ®å˜äº†æ‰å†™å…¥ç£ç›˜
                  if should_write:
                      with open(file_path, "w", encoding="utf-8") as f:
                          f.write(new_full_content)
                      print(f"å†™å…¥ {file_path}: æ£€æµ‹åˆ°æ•°æ®æ›´æ–°")
                      
          except Exception as e:
              print(f"é”™è¯¯: {e}")
              exit(1)
        shell: python

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ—ƒï¸ Archive stats (Auto)"
          file_pattern: 'tournament/*.md'
          commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
