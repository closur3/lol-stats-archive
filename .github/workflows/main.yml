name: Archive Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch and Smart Update
        env:
          WORKER_URL: "https://lol-stats.closur3.workers.dev/backup"
        run: |
          import requests
          import os
          import re
          from datetime import datetime, timedelta, timezone

          # --- 1. è®¾ç½®åŒ—äº¬æ—¶é—´ (UTC+8) ---
          # ä¿®æ­£ï¼šåŠ å›ç§’æ•° (%S)
          cst_tz = timezone(timedelta(hours=8))
          now_cst = datetime.now(cst_tz).strftime("%Y-%m-%d %H:%M:%S")
          
          url = os.environ.get("WORKER_URL")
          if not url:
              print("âŒ é”™è¯¯: WORKER_URL ç¯å¢ƒå˜é‡æœªè®¾ç½®")
              exit(1)

          # --- 2. æ­£åˆ™é…ç½® ---
          # ä½œç”¨ï¼šåŒ¹é… "Updated: 2026-xx-xx ... (CST)" è¿™ä¸€æ•´è¡Œ
          # æ— è®ºæ—¶é—´æ€ä¹ˆå˜ï¼Œè¿™è¡Œéƒ½ä¼šè¢«å‰”é™¤åå†æ¯”å¯¹å‰©ä½™å†…å®¹
          TIME_PATTERN = re.compile(r"^Updated:.*\(CST\)$", re.MULTILINE)

          print(f"ğŸš€ å¼€å§‹æŠ“å–: {url}")

          try:
              resp = requests.get(url, timeout=30)
              resp.raise_for_status()
              data = resp.json()
              
              changes_count = 0

              for file_path, raw_template in data.items():
                  # ç¡®ä¿ç›®å½•å­˜åœ¨
                  os.makedirs(os.path.dirname(file_path), exist_ok=True)
                  
                  # === æ ¸å¿ƒæ¯”å¯¹é€»è¾‘ ===
                  
                  # A. å‡†å¤‡æ–°æ•°æ®çš„â€œæŒ‡çº¹â€ï¼ˆç§»é™¤æ¨¡æ¿ä¸­çš„å ä½ç¬¦è¡Œï¼‰
                  # raw_template é‡Œæ˜¯ {{UPDATED_TIME}}ï¼Œæ­£åˆ™ä¹Ÿä¼šå°†å…¶ç§»é™¤
                  clean_new = TIME_PATTERN.sub("", raw_template).strip()
                  
                  should_write = True
                  
                  # B. è¯»å–æœ¬åœ°æ—§æ–‡ä»¶
                  if os.path.exists(file_path):
                      with open(file_path, "r", encoding="utf-8") as f:
                          old_content = f.read()
                      
                      # C. å‡†å¤‡æ—§æ•°æ®çš„â€œæŒ‡çº¹â€ï¼ˆç§»é™¤æ—§æ–‡ä»¶é‡Œçš„æ—¶é—´è¡Œï¼‰
                      clean_old = TIME_PATTERN.sub("", old_content).strip()
                      
                      # D. æ¯”å¯¹æŒ‡çº¹ï¼ˆä¸å«æ—¶é—´çš„å†…å®¹ï¼‰
                      if clean_old == clean_new:
                          print(f"â­ï¸  [è·³è¿‡] {file_path}: æ¯”èµ›æ•°æ®æ— å˜åŒ–")
                          should_write = False
                      else:
                          print(f"âš¡  [æ›´æ–°] {file_path}: æ£€æµ‹åˆ°æ•°æ®å˜åŠ¨")
                  else:
                      print(f"âœ¨  [æ–°å»º] {file_path}")

                  # === å†™å…¥é€»è¾‘ ===
                  if should_write:
                      # åªæœ‰ç¡®å®šè¦å†™çš„æ—¶å€™ï¼Œæ‰æŠŠå½“å‰å¸¦ç§’çš„æ—¶é—´å¡«è¿›å»
                      final_content = raw_template.replace("{{UPDATED_TIME}}", now_cst)
                      
                      with open(file_path, "w", encoding="utf-8") as f:
                          f.write(final_content)
                          changes_count += 1
              
              print(f"\nå¤„ç†å®Œæˆã€‚å…±æ›´æ–° {changes_count} ä¸ªæ–‡ä»¶ã€‚")

          except Exception as e:
              print(f"âŒ è„šæœ¬æ‰§è¡Œå‘ç”Ÿé”™è¯¯: {e}")
              exit(1)
        shell: python

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ—ƒï¸ Auto: Archive stats"
          file_pattern: 'tournament/*.md'
