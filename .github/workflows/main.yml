name: Archive Stats

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch and Process Data
        env:
          WORKER_URL: "https://lol-stats.closur3.workers.dev/backup"
        run: |
          import requests
          import os
          import re
          from datetime import datetime, timedelta, timezone

          cst_tz = timezone(timedelta(hours=8))
          now_cst = datetime.now(cst_tz).strftime("%Y-%m-%d %H:%M:%S")

          url = os.environ["WORKER_URL"]
          print(f"æ­£åœ¨æŠ“å–: {url}")

          try:
              resp = requests.get(url, timeout=30)
              resp.raise_for_status()
              data = resp.json()

              for file_path, content in data.items():
                  should_write = True

                  if os.path.exists(file_path):
                      with open(file_path, "r", encoding="utf-8") as f:
                          old_content = f.read()

                      clean_old = re.sub(
                          r"\*\*Updated:\*\* \d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2} \(CST\)",
                          "{{UPDATED_TIME}}",
                          old_content
                      ).strip()
                      clean_new = content.strip()

                      if clean_old == clean_new:
                          print(f"è·³è¿‡ {file_path}: æ•°æ®æ— å˜åŒ–")
                          should_write = False

                  if should_write:
                      new_full_content = content.replace("{{UPDATED_TIME}}", now_cst)
                      os.makedirs(os.path.dirname(file_path), exist_ok=True)
                      with open(file_path, "w", encoding="utf-8") as f:
                          f.write(new_full_content)
                      print(f"å†™å…¥ {file_path}: æ£€æµ‹åˆ°æ•°æ®æ›´æ–°")

          except Exception as e:
              print(f"é”™è¯¯: {e}")
              exit(1)
        shell: python

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ—ƒï¸ Archive stats (Auto)"
          file_pattern: 'tournament/*.md'
          commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
